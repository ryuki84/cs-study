# Lock & MVCC (Database Lock and MVCC)

## 1. 개념 정리
Lock(락)은
여러 트랜잭션이 동시에 동일한 데이터에 접근할 때
데이터 정합성을 보장하기 위해 접근을 제한하는 메커니즘이다.

일반적으로 다음과 같은 락이 사용된다.

- Shared Lock (읽기 락): 동시에 여러 트랜잭션이 읽기 가능
- Exclusive Lock (쓰기 락): 하나의 트랜잭션만 쓰기 가능
- Row Lock / Table Lock: 적용 범위에 따른 구분

MVCC(Multi Version Concurrency Control)는
락을 최소화하면서도 일관된 읽기를 제공하기 위해
데이터의 여러 버전을 관리하는 방식이다.

MVCC에서는
- 읽기 작업은 락 없이 수행되고
- 쓰기 작업은 새로운 버전을 생성한다

즉,
- Lock은 **정합성 보장 중심**
- MVCC는 **동시성 성능 개선 중심**

의 개념이다.

---

## 2. 왜 중요한가
백엔드 서버에서는
다수의 트랜잭션이 동시에 데이터에 접근한다.

락과 MVCC를 이해하지 못하면:
- 조회가 느려지는 원인 파악 불가
- 락 대기(lock wait)로 인한 성능 저하
- 데드락 발생 원인 분석 실패
- 트랜잭션 격리 수준에 대한 오해

와 같은 문제가 발생한다.

특히 트래픽이 많은 서비스에서는
락 설계 하나로 성능과 안정성이 크게 달라진다.

---

## 3. 백엔드 실무 관점
실무에서의 핵심 포인트는 다음과 같다.

- 단순 조회는 가능한 한 MVCC 기반 읽기 사용
- 불필요한 쓰기 트랜잭션 최소화
- 트랜잭션 범위를 짧게 유지
- 인덱스를 활용해 락 범위 축소

예를 들어:
- 조회 쿼리에 불필요한 `FOR UPDATE` 사용은 락 경합을 유발
- 인덱스가 없는 조건으로 UPDATE 수행 시 테이블 락 위험 증가

MVCC 기반 DB(MySQL InnoDB 등)에서는
일반 SELECT가 락을 걸지 않기 때문에
읽기 성능과 동시성이 크게 향상된다.

---

## 4. 트레이드오프 / 주의사항
- 락은 정합성을 보장하지만 성능 비용이 크다.
- MVCC는 동시성에 유리하지만
  - Undo Log 관리 비용
  - 오래된 트랜잭션으로 인한 정리 지연
  문제가 발생할 수 있다.
- 잘못된 락 설계는 데드락 가능성을 높인다.

즉,
> 락은 최소한으로 사용하고,
> MVCC의 특성을 이해한 설계가 필요하다.

라는 트레이드오프가 존재한다.

---

## 5. 예상 면접 질문 & 답변 연습

### Q1. DB에서 락은 왜 필요한가요?
A.
여러 트랜잭션이 동시에 데이터를 수정할 때
데이터 정합성을 보장하고
동시 수정으로 인한 오류를 방지하기 위해 필요합니다.

---

### Q2. MVCC는 어떤 문제를 해결하나요?
A.
읽기 작업에 락을 걸지 않고도
일관된 데이터를 조회할 수 있게 해
락 경합을 줄이고 동시 처리 성능을 향상시킵니다.

---

### Q3. MVCC가 있는데도 락이 필요한 이유는 무엇인가요?
A.
쓰기 작업 간 충돌을 방지하고
데이터 무결성을 보장하기 위해
여전히 락은 필요합니다.

---

## 6. 한 문장 요약 (면접용)
락은 데이터 정합성을 보장하기 위한 장치이고,
MVCC는 락을 최소화해
동시성과 성능을 개선하는 데이터 관리 방식이다.
